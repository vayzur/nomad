---
- name: Make Xray directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: 0755
  loop:
    - "{{ xray_dir }}"
    - /etc/systemd/system/xray@.service.d
    - /etc/systemd/system/xray.service.d
    - /var/log/xray

- name: Download Xray binary
  get_url:
    url: "https://github.com/XTLS/Xray-core/releases/download/{{ xray_version }}/Xray-linux-64.zip"
    dest: "/tmp/Xray-linux-64.zip"
    mode: 0644

- name: Extract Xray binary
  unarchive:
    src: "/tmp/Xray-linux-64.zip"
    dest: "{{ xray_dir }}"
    remote_src: true
  changed_when: true

- name: Check if wormhole.json exists
  become: false
  stat:
    path: "{{ role_path }}/files/wormhole.json"
  register: wormhole_config
  delegate_to: localhost
  tags:
    - xray-service

- name: Check if stargate.json exists
  become: false
  stat:
    path: "{{ role_path }}/files/stargate.json"
  register: stargate_config
  delegate_to: localhost
  tags:
    - xray-service

- name: Define source file for wormhole
  set_fact:
    wormhole_src: "{{ 'files/wormhole.json' if wormhole_config.stat.exists else 'files/default.json' }}"
  when: inventory_hostname == 'wormhole'
  tags:
    - xray-service

- name: Define source file for stargate
  set_fact:
    stargate_src: "{{ 'files/stargate.json' if stargate_config.stat.exists else 'files/default.json' }}"
  when: inventory_hostname == 'stargate'
  tags:
    - xray-service

- name: Copy Xray custom config to wormhole
  copy:
    src: "{{ wormhole_src }}"
    dest: "{{ xray_dir }}/config.json"
    owner: root
    group: root
    mode: 0644
  when: inventory_hostname == 'wormhole'
  tags:
    - xray-service

- name: Copy Xray custom config to stargate
  copy:
    src: "{{ stargate_src }}"
    dest: "{{ xray_dir }}/config.json"
    owner: root
    group: root
    mode: 0644
  when: inventory_hostname == 'stargate'
  tags:
    - xray-service

- name: Generate taskset CPU mask for xray service
  set_fact:
    cpu_mask: >-
      {% if ansible_processor_vcpus|int == 1 %}0{% elif ansible_processor_vcpus|int == 2 %}1{% else %}1-{{ ansible_processor_vcpus | int - 1 }}{% endif %}
  tags:
    - xray-service

- name: Make Xray systemd service
  template:
    src: xray.service.j2
    dest: /etc/systemd/system/xray.service
    owner: root
    group: root
    mode: 0644
  changed_when: true
  notify:
    - Enable xray
  tags:
    - xray-service

- name: Remove Xray downloaded zip file
  file:
    path: "/tmp/Xray-linux-64.zip"
    state: absent
